<!DOCTYPE html>
<html>
<head>
<style>
body {
  font-family: Arial, Helvetica, sans-serif;
}

.grid-container {
  display: grid;
  grid-template-columns: auto auto auto auto auto;
  padding: 10px;
  gap: 10px;
}
.slide {
  background-color: #f1f1f1;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3);

}
</style>
</head>
<body>

<h3 onClick="window.location.reload();" style="color:darkcyan;cursor: pointer;padding-left: 10px;margin:0">Refresh Presentation</h3>
<!-- <i><pre id="controlStatus" style="color:gray;padding-left: 10px;margin:0">Control Disabled</pre></body></i> -->
<div class="grid-container">
</div>

</body>
<script>
  // TODO: live feedback of active slide if Pro7 active slide changes by means other than this web app telling it to.
  // TODO: live feedback for lose of control if active presentation changes away from controllable presentation
  // TODO: nicer method to lock down to desired presentation instead of hard coded name  - Perhaps an electron app as middle-man where operator can select a presentation to make it controlable?)\
  // TODO: make grid/slides more "responsive" (scale up and down the slides as container is resized)

// ***** UPDATE THESE VALUES TO SUIT YOUR SETUP ******* 
var ipAddressOfProPresenterComputer = '127.0.0.1' // Hostname can used used here also if you have hostname resolution for your ProPresenter computer
var networkPortOfProPresenter = '50001' // See ProPresenter network prefs
var nameOfPresentationToControl = "Message" // This web page will be able to control a presentation is the name matches
// ****************************************************


var currentSlideIndex = -1;
var currentPresentationUUID;
var currentPresentationName;
var presentationInfo;
var xmlHttp = new XMLHttpRequest();

xmlHttp.open( 'GET', 'http://' + ipAddressOfProPresenterComputer + ':' + networkPortOfProPresenter + '/v1/presentation/current');
xmlHttp.onload = function(e) {
  if (xmlHttp.status == 200) {
    
    try {
      presentationInfo = JSON.parse(xmlHttp.response);
      currentPresentationUUID = presentationInfo.presentation.id.uuid;
      currentPresentationName = presentationInfo.presentation.id.name;
      console.log('Response: ' + xmlHttp.response);
      getSlide(0); // start recursively getting all slide thumbs...
    } catch (error) {
      console.log('error:' + error);
    }
  }
};
xmlHttp.send()


function getSlide(slideIndex) {
  var xhr = new XMLHttpRequest();

  xhr.open('GET', 'http://' + ipAddressOfProPresenterComputer + ':' + networkPortOfProPresenter + '/v1/presentation/' + currentPresentationUUID + '/thumbnail/' + slideIndex + '?quality=300', true);
  xhr.responseType = 'blob';

  xhr.onload = () => {
    if (xhr.status == 200) {
    slideElement = document.createElement('img');
    slideElement.setAttribute('class','slide');
    slideElement.setAttribute('src', window.URL.createObjectURL(xhr.response));
    if (currentPresentationName != nameOfPresentationToControl) {
      slideElement.setAttribute('style', 'opacity:0.5')
    }
    slideElement.slideIndex = slideIndex;
    slideElement.addEventListener("click", handleClick);
    document.querySelector('.grid-container').appendChild(slideElement);
    getSlide(slideIndex+1); // Keep calling for next slide thumbnail until we fail with a 404 - need to do it this way since there is no way to astertain # of slides when a presentation has a custom arrangement active.
    }
  };

  xhr.send();
      
}



document.addEventListener("keypress",handleKeyPress) // Allow spacebar to go to next slide.

function handleKeyPress (event) {
	if (event.key == " ") {
    	event.preventDefault();
        if (currentSlideIndex < document.querySelectorAll(".slide").length-1) {
    		triggerSlide(currentSlideIndex+1);
        }
    }
}

function handleClick(event) {
	console.log("Slide clicked: " + event.currentTarget.slideIndex);
	triggerSlide(event.currentTarget.slideIndex);
}

function triggerSlide(slideIndex) {
  xmlHttp.open( 'GET', 'http://' + ipAddressOfProPresenterComputer + ':' + networkPortOfProPresenter + '/v1/presentation/current');
  xmlHttp.onload = function(e) {
    if (xmlHttp.status == 200) {
      
      try {
        presentationInfo = JSON.parse(xmlHttp.response);
        // Only proceed if current presenation is of correct name
        if (presentationInfo.presentation.id.name == nameOfPresentationToControl) {
          xmlHttp.open( 'GET', 'http://' + ipAddressOfProPresenterComputer + ':' + networkPortOfProPresenter + '/v1/presentation/' + currentPresentationUUID + '/trigger/' + slideIndex);
          xmlHttp.onload = function(e) {
            if (currentSlideIndex >=0) {
              document.querySelectorAll(".slide")[currentSlideIndex].setAttribute("style","");
            }
            document.querySelectorAll(".slide")[slideIndex].setAttribute("style","outline-style:solid; outline-color:orange; outline-width:7px");
            currentSlideIndex = slideIndex;
          }
          xmlHttp.send( null );
        }

      } catch (error) {
        console.log('error:' + error);
      }
    }
  };
xmlHttp.send()  




	  

}
</script>
</html>
